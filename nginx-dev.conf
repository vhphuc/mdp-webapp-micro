events {
    worker_connections 1024;
}

http {
    upstream dtf_hat {
        server dtf_hat:8080;
    }

    server {
        listen 80;
        server_name localhost;
        port_in_redirect on;

        # Route /dtf-hat path to dtf-hat service
        # Mimics AKS ingress behavior where /dtf-hat prefix is forwarded to the service
        # Use /dtf-hat/ with trailing slash to match exact path prefix behavior
        location /dtf-hat/ {
            # Preserve the path prefix when forwarding to upstream (no trailing slash in proxy_pass)
            # This matches AKS ingress behavior where paths are preserved
            # Request: /dtf-hat/dashboard -> forwarded to dtf_hat:8080 as /dtf-hat/dashboard
            proxy_pass http://dtf_hat;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_redirect off;
        }
        
        # Handle /dtf-hat without trailing slash - rewrite to add trailing slash (no redirect)
        location = /dtf-hat {
            rewrite ^/dtf-hat$ /dtf-hat/ last;
        }

        # Health check endpoint
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
}

