trigger:
  branches:
    include:
      - test
  paths:
    include:
      - apps/qa-pod/**
      - devops/test/qa-pod/k8s/**

pool: 'NOIS-TaiVo'

variables:
  - group: MDP TEST
  repository: 'mdp-webapp-qa-pod'
  dockerfile: 'apps/qa-pod/Dockerfile'
  k8sPath: 'devops/test/qa-pod/k8s'
  k8sSvcEndpoint: 'aks-test'
  oldImageTag: 'test'
  imageTag: 'test-$(Build.BuildId)'

steps:
  - task: Docker@2
    inputs:
      containerRegistry: 'md-acr-2023'
      repository: '$(repository)'
      command: 'buildAndPush'
      Dockerfile: '$(dockerfile)'
      buildContext: 'apps/qa-pod'
      tags: '$(imageTag)'

  - powershell: (Get-Content $(k8sPath)/deployment.yaml) -replace '$(repository):$(oldImageTag)', '$(repository):$(imageTag)' | Set-Content $(k8sPath)/deployment.yaml
    displayName: 'Change Template'

  - task: Kubernetes@1
    inputs:
      connectionType: 'Kubernetes Service Connection'
      kubernetesServiceEndpoint: '$(k8sSvcEndpoint)'
      namespace: 'mdp'
      command: 'apply'
      arguments: '-f $(k8sPath)'
      secretType: 'dockerRegistry'
      containerRegistryType: 'Azure Container Registry'
