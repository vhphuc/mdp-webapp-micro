# Run all apps
#   docker compose up               # --build: rebuild images if needed
#   docker compose down             # stop and remove containers, networks
# comment services that you dont need (proxy is required, shell should be enabled for ease of access to all apps)
#
# The nginx config is automatically generated by the nginx_init service before proxy starts
# Only enabled (not commented out) services will be configured in nginx

services:
  # Init service: generates nginx-local.conf based on enabled services in docker-compose.yml
  nginx_init:
    image: node:20-alpine
    volumes:
      - ./docker-compose.yml:/docker-compose.yml:ro
      - ./generate-nginx-config.js:/generate-nginx-config.js:ro
      - ./nginx-local.conf:/nginx-local.conf
    environment:
      - COMPOSE_FILE=/docker-compose.yml
      - OUTPUT_FILE=/nginx-local.conf
    command: ["node", "/generate-nginx-config.js"]
    restart: "no"  # Only run once, don't restart on failure

  # Nginx proxy to mimic production ingress behavior
  proxy:
    image: nginx:alpine
    # Expose local port 4799 -> container port 80 (Nginx)
    ports:
      - "4799:80"
    # Use local Nginx config to route to app services
    volumes:
      - ./nginx-local.conf:/etc/nginx/nginx.conf
    # Depends on nginx_init to generate config before starting
    depends_on:
      nginx_init:
        condition: service_completed_successfully
      # Ensures these services start before proxy, but does not wait for health/readiness
      shell:
        condition: service_started
      dtf_hat:
        condition: service_started
      embroidery:
        condition: service_started
      hangtag:
        condition: service_started
      # - qa
      # - shipping
      # - neck_label
      
      # - jit_receive
      # - mug_transfer
      # - print_leadd
      # - qa_lead
      # - qa_pod
      # - trim
      # - washing
    restart: unless-stopped

  # shell: include all-apps page
  shell:
    build:
      context: ./apps/shell
      dockerfile: Dockerfile.local
    # Angular dev server; --host 0.0.0.0 binds to all interfaces so host can access it
    # poll: 2000ms to detect changes
    command: ["pnpm", "exec", "ng", "serve", "--host", "0.0.0.0", "--poll", "2000"]
    # Mount only source for live reload while keeping dependencies inside the image
    volumes:
      - ./apps/shell/src:/app/src
    restart: unless-stopped

  dtf_hat:
    build:
      context: ./apps/dtf-hat
      dockerfile: Dockerfile.local
    # Angular dev server exposed to host via proxy
    # poll: 2000ms to detect changes
    command: ["pnpm", "exec", "ng", "serve", "--host", "0.0.0.0", "--poll", "2000"]
    # Mount only source for live reload while keeping dependencies inside the image
    volumes:
      - ./apps/dtf-hat/src:/app/src
    restart: unless-stopped  

  embroidery:
    build:
      context: ./apps/embroidery
      dockerfile: Dockerfile.local
    # Angular dev server exposed to host via proxy
    # poll: 2000ms to detect changes
    command: ["pnpm", "exec", "ng", "serve", "--host", "0.0.0.0", "--poll", "2000"]
    # Mount only source for live reload while keeping dependencies inside the image
    volumes:
      - ./apps/embroidery/src:/app/src
    restart: unless-stopped 

  hangtag:
    build:
      context: ./apps/hang-tag
      dockerfile: Dockerfile.local
    # Angular dev server exposed to host via proxy
    # poll: 2000ms to detect changes
    command: ["pnpm", "exec", "ng", "serve", "--host", "0.0.0.0", "--poll", "2000"]
    # Mount only source for live reload while keeping dependencies inside the image
    volumes:
      - ./apps/hang-tag/src:/app/src
    restart: unless-stopped

  # qa:
    #   build:
    #     context: ./apps/qa
    #     dockerfile: Dockerfile.dev
    #   command: ["npm", "start", "--host", "0.0.0.0", "--poll", "2000", "--port", "4201"]
    #   volumes:
    #     - ./apps/qa/src:/app/src
    #   restart: unless-stopped

  # neck_label:
  #   build:
  #     context: ./apps/neck-label
  #     dockerfile: Dockerfile.local
  #   command: ["yarn", "start", "--host", "0.0.0.0", "--poll", "2000", "--port", "4202"]
  #   volumes:
  #     - ./apps/neck-label/src:/app/src
  #   restart: unless-stopped

  # shipping:
  #   build:
  #     context: ./apps/shipping
  #     dockerfile: Dockerfile.local
  #   command: ["yarn", "start", "--host", "0.0.0.0", "--poll", "2000", "--port", "4203"]
  #   volumes:
  #     - ./apps/shipping/src:/app/src
  # 
  # 
  #   restart: unless-stopped

  # jit_receive:
  #   build:
  #     context: ./apps/jit-receive
  #     dockerfile: Dockerfile.local
  #   command: ["yarn", "start", "--host", "0.0.0.0", "--poll", "2000", "--port", "4207"]
  #   volumes:
  #     - ./apps/jit-receive/src:/app/src
  #   restart: unless-stopped

  # mug_transfer:
  #   build:
  #     context: ./apps/mug-transfer
  #     dockerfile: Dockerfile.local
  #   command: ["yarn", "start", "--host", "0.0.0.0", "--poll", "2000", "--port", "4208"]
  #   volumes:
  #     - ./apps/mug-transfer/src:/app/src
  #   restart: unless-stopped

  # print_lead:
  #   build:
  #     context: ./apps/print-lead
  #     dockerfile: Dockerfile.local
  #   command: ["yarn", "start", "--host", "0.0.0.0", "--poll", "2000", "--port", "4209"]
  #   volumes:
  #     - ./apps/print-lead/src:/app/src
  #   restart: unless-stopped

  # qa_lead:
  #   build:
  #     context: ./apps/qa-lead
  #     dockerfile: Dockerfile.local
  #   command: ["yarn", "start", "--host", "0.0.0.0", "--poll", "2000", "--port", "4210"]
  #   volumes:
  #     - ./apps/qa-lead/src:/app/src
  #   restart: unless-stopped

  # qa_pod:
  #   build:
  #     context: ./apps/qa-pod
  #     dockerfile: Dockerfile.local
  #   command: ["yarn", "start", "--host", "0.0.0.0", "--poll", "2000", "--port", "4211"]
  #   volumes:
  #     - ./apps/qa-pod/src:/app/src
  #   restart: unless-stopped

  # trim:
  #   build:
  #     context: ./apps/trim
  #     dockerfile: Dockerfile.local
  #   command: ["yarn", "start", "--host", "0.0.0.0", "--poll", "2000", "--port", "4212"]
  #   volumes:
  #     - ./apps/trim/src:/app/src
  #   restart: unless-stopped

  # washing:
  #   build:
  #     context: ./apps/washing
  #     dockerfile: Dockerfile.local
  #   command: ["yarn", "start", "--host", "0.0.0.0", "--poll", "2000", "--port", "4213"]
  #   volumes:
  #     - ./apps/washing/src:/app/src
  #   restart: unless-stopped
